---
title: "Datamanagement - Project Adv R"
output: html_document
date: "2025-08-21"
---

```{r, message=FALSE}
#We start by loading our packages

library(rayshader) 
library(rgl)
library(av)
library(gifski)
library(magick) #The first five are just for the 3d-model gif. 
library(ggplot2) 
library(dplyr)
library(magrittr) #should be included in dplyr, but didn't work?
library(plotly) #For interactive ggplot
library(hrbrthemes) #For better ggplot-themes
```


```{r, message=FALSE}
#First we load our data into our environment

library(tidytuesdayR) #Specific package for loading tidy-tuesday data

tuesdata <- tidytuesdayR::tt_load('2025-06-24') 

cases_month <- tuesdata$cases_month #Loading datasets into environment
cases_year <- tuesdata$cases_year   #Loading datasets into environment

dim(cases_year)
```



```{r}
#Looking at variable names
names(cases_month)
names(cases_year)
```


```{r}
#Recoding regions for OUR understanding
cases_year <- cases_year %>% 
  mutate(region = recode(region, `AFRO` = "African Region", `AMRO` = "Region of Americas", `EMRO` = "Eastern Mediterraenean Region", `EURO` = "European Region", `SEARO` = "Sout-East Asian Region", `WPRO` = "Western Pacific Region"))
cases_month <- cases_month %>% 
  mutate(region = recode(region, `AFR` = "African Region", `AMR` = "Region of Americas", `EMR` = "Eastern Mediterraenean Region", `EUR` = "European Region", `SEAR` = "Sout-East Asian Region", `WPR` = "Western Pacific Region"))
```


```{r}
unique(cases_month$region)
```


```{r, message=FALSE}
#First we want to look at the overall average incidence rate pr. year worldwide
cases_year %>%
  group_by(year) %>% #Grouping by year
  mutate(avg_inc = mean(measles_incidence_rate_per_1000000_total_population)) %>% #Creating new variable with mutate
ggplot(aes(x = year, y = avg_inc)) + #inserting mapping-argument in overall ggplot for less typing
  geom_point() +
  theme_bw() +
  labs(title = "Avg. measles incidence rate worldwide \n(pr. 1,000,000)", x = "Year", y = "Avg. Incidence Rate") + #Notice the \n for changing                                                                                                                      #line
  geom_smooth() +
  geom_text(aes(label = round(avg_inc)), vjust = 1.5, size = 3) #Putting avg_incidence text for each point and adjusting size and position
```


```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=5}

#Now we want to facet by region. We supress warnings and messages in the output in the first row. 
plotfacet <- cases_year %>%
  group_by(year, region) %>%    #We group by year AND region so we get an annual avg. pr. region
  mutate(avg_reg = mean(measles_incidence_rate_per_1000000_total_population)) %>% 
ggplot() + 
  geom_point(aes(x = year, y = avg_reg, colour = region, shape = region)) +
  theme_bw() +
  labs(title = "Avg. measles incidence rate pr. region pr. year(pr. 1,000,000)", x = "Year", y = "Avg. Incidence Rate", color = "Region", shape = "Region") +
  geom_smooth(aes(x = year, y = avg_reg), color = "grey", se=FALSE, show.legend = FALSE) + 
  facet_wrap(~ region, scales = "free") +
  geom_line(aes(x = year, y = avg_reg, colour = region, shape = region)) + 
  theme(strip.text = element_text(
    color = "white"),
        strip.background = element_rect(
    fill = "grey20")) #Changing the top bar colour and the text color 

ggplotly(plotfacet)
  
```






```{r}
cases_year1 <- cases_year %>% 
  group_by(year, region) %>% 
  mutate(avg_reg = mean(measles_incidence_rate_per_1000000_total_population)) 

hexgg <-  ggplot(cases_year1, aes(x =  year, y = avg_reg)) +
    stat_bin_hex(aes(fill = after_stat(density), colour = after_stat(density)), 
                 bins = 10,
                 linewidth = 1) +
    scale_fill_viridis_c(option = "B") +
    scale_color_viridis_c(option = "B", guide = "none") +
    labs(x = "Year", y = "Avg. incidence rate pr. region", fill = "",
         colour = "") +
    theme_minimal()
hexgg
```

```{r, message=FALSE, results='hide'}
plot_gg(hexgg, multicore = TRUE, windowsize = c(800, 800))

render_movie("silly.gif")

```

```{r}
knitr::include_graphics('C:/Users/au483794/OneDrive - Aarhus universitet/Documents/Fridayproject/Peter/silly.gif')
```


```{r, warning=FALSE, fig.width=10, fig.height=5}
cases_month %>%
  mutate(region = as.factor(region)) %>% 
  ggplot(aes(x = measles_suspect, y = measles_lab_confirmed, color = region)) +
  geom_point() + 
  facet_wrap(~region) + 
  theme_bw() + 
  labs(x = "Suspected cases of measles", y = "Laboratory confirmed cases of measles", color = "Region")
  
  
europetest <- cases_month %>%
  mutate(region = as.factor(region)) %>% 
  filter(region == "European Region")

europetest %>% 
  ggplot(aes(x = measles_suspect, y = measles_lab_confirmed, color = region)) +
  geom_point() + 
  facet_wrap(~region) + 
  theme_bw() + 
  labs(x = "Suspected cases of measles", y = "Laboratory confirmed cases of measles", color = "Region") + 
  coord_fixed()
  
  
```

```{r}
europetest %>% 
  filter(iso3 == "KAZ") %>% 
  arrange(desc(measles_lab_confirmed), measles_suspect) %>% 
  select(country, measles_suspect, measles_lab_confirmed, measles_clinical, year) %>% 
  print(n = 20)
```





```{r, message=FALSE}
library(gganimate)
library(rnaturalearth)
library(sf)
```

```{r, message=FALSE}
# Load world map
world <- ne_countries(scale = "medium", returnclass = "sf") 
world <- world %>% 
  select(name, geometry)
```


```{r}
#Calculating avg. incidente pr. 1,000,000 pr. country pr. year. 
cases_year_gif <- cases_year %>% 
  group_by(year, country) %>% 
  mutate(avg_country = mean(measles_incidence_rate_per_1000000_total_population))
```


```{r}
# Joining data to map
map_data <- left_join(world,cases_year_gif, by = c("name" = "country"))
```

```{r}
#Creating an interactive world-map showing incidence by country pr. year by color-coding. 
library(plotly)
library(viridisLite)
fig <- plot_geo(cases_year_gif) %>%
  add_trace(
    z = ~avg_country,
    color = ~avg_country,
    colors = viridis(256, option = "D"),
    text = ~paste0(country, "<br>Incidence: ", avg_country),
    locations = ~country,
    locationmode = "country names",
    frame = ~year
  ) %>%
  colorbar(title = "Incidence")
fig %>% 
  layout(
    title = "Measles Incidence by Country per Year",
  geo = list(
    projection = list(type = 'natural earth'),
    showland = TRUE,
    landcolor = 'rgb(230, 230, 230)',
    lakecolor = 'rgb(255, 255, 255)',
    showcountries = TRUE
  )
) 
```


```{r}

# summarise average incidence per region Ã— year
cases_year2 <- cases_year %>% 
  group_by(year, region) %>% 
  summarise(avg_reg = mean(measles_incidence_rate_per_1000000_total_population, na.rm = TRUE))

# pivot to wide format for heatmap
cases_wide <- cases_year2 %>%
  pivot_wider(names_from = year, values_from = avg_reg)

# convert to matrix
mat <- as.matrix(cases_wide[,-1])   # remove "region"
rownames(mat) <- cases_wide$region  # set rownames to regions

# Heatmap
Heatmap(mat,
        name = "Measles Incidence",
        col = viridis::viridis(100),
        cluster_rows = F,
        cluster_columns = F,border = T,
        rect_gp = gpar(col = "white", lwd = 1.5),
        column_title = "Heatmap to show measiles Incident per year per region ")



```



